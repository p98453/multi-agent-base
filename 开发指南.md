# å¤šæ™ºèƒ½ä½“å®‰å…¨åˆ†æç³»ç»Ÿ â€” å¼€å‘æ–‡æ¡£

## ç³»ç»Ÿæ¶æ„

### ä¸‰å±‚æ¶æ„

```
Frontend (Streamlit)  â†â†’  Backend (FastAPI)  â†â†’  Agent System (Multi-Agent)
        â†“                        â†“                         â†“
    ç”¨æˆ·ç•Œé¢              RESTful API               æ™ºèƒ½åˆ†æ + LLM
                              â†“
                      MemoryStorage (å†…å­˜å­˜å‚¨)
```

---

## ç›®å½•ç»“æ„è¯¦è§£

### åç«¯æ¨¡å— (`backend/`)

```
backend/
â”œâ”€â”€ main.py                 # FastAPI åº”ç”¨å…¥å£ï¼Œç”Ÿå‘½å‘¨æœŸç®¡ç†
â”œâ”€â”€ config.py              # é…ç½®ç®¡ç†ï¼ˆä» .env è¯»å–ï¼‰
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ analysis.py   # å‘Šè­¦åˆ†æ + å†å²è®°å½• API
â”‚   â”‚   â””â”€â”€ stats.py      # ç»Ÿè®¡ä¿¡æ¯ + å¥åº·æ£€æŸ¥ API
â”‚   â””â”€â”€ models/
â”‚       â””â”€â”€ schemas.py    # Pydantic æ•°æ®æ¨¡å‹
â””â”€â”€ services/
    â”œâ”€â”€ agent_service.py  # æ™ºèƒ½ä½“æœåŠ¡å°è£…ï¼ˆä¸šåŠ¡ç¼–æ’å±‚ï¼‰
    â””â”€â”€ memory_storage.py # å†…å­˜å†å²å­˜å‚¨ï¼ˆæ›¿ä»£ ChromaDBï¼‰
```

**å…³é”®æ–‡ä»¶è¯´æ˜**:

| æ–‡ä»¶ | èŒè´£ |
|------|------|
| `main.py` | FastAPI åº”ç”¨ï¼Œé…ç½® CORSã€æ³¨å†Œè·¯ç”±ã€ç®¡ç†å¯åŠ¨/å…³é—­ç”Ÿå‘½å‘¨æœŸ |
| `config.py` | ç»Ÿä¸€é…ç½®ç®¡ç†ï¼Œè¯»å– `.env` ç¯å¢ƒå˜é‡ï¼ŒéªŒè¯å¿…éœ€é…ç½® |
| `agent_service.py` | ä¸šåŠ¡ç¼–æ’å±‚ï¼Œå°è£… MultiAgentSystem è°ƒç”¨ï¼Œç®¡ç†åˆ†æå†å² |
| `memory_storage.py` | å†…å­˜ä¸­å­˜å‚¨åˆ†æè®°å½•ï¼Œæ”¯æŒè¿‡æ»¤æŸ¥è¯¢å’Œç»Ÿè®¡ |

### å‰ç«¯æ¨¡å— (`frontend/`)

```
frontend/
â”œâ”€â”€ app.py                 # Streamlit ä¸»é¡µé¢ï¼ˆç³»ç»Ÿä»‹ç»ï¼‰
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ 1_ğŸ”_Alert_Analysis.py      # å‘Šè­¦åˆ†æï¼ˆè¾“å…¥+ç»“æœå±•ç¤ºï¼‰
â”‚   â”œâ”€â”€ 2_ğŸ“Š_Analysis_History.py    # å†å²è®°å½•ï¼ˆè¡¨æ ¼+è¿‡æ»¤ï¼‰
â”‚   â””â”€â”€ 4_ğŸ“ˆ_System_Dashboard.py    # ç³»ç»Ÿä»ªè¡¨æ¿ï¼ˆç»Ÿè®¡å›¾è¡¨ï¼‰
â””â”€â”€ utils/
    â””â”€â”€ api_client.py     # HTTP å®¢æˆ·ç«¯ï¼ˆå°è£…åç«¯ API è°ƒç”¨ï¼‰
```

### æ™ºèƒ½ä½“ç³»ç»Ÿ (`src/`)

```
src/
â”œâ”€â”€ agents/
â”‚   â”œâ”€â”€ optimized_router.py   # è·¯ç”±æ™ºèƒ½ä½“ï¼ˆå…³é”®è¯+æ­£åˆ™è§„åˆ™å¼•æ“ï¼‰
â”‚   â”œâ”€â”€ optimized_expert.py   # ä¸“å®¶æ™ºèƒ½ä½“ï¼ˆLLM åˆ†æ + è§„åˆ™é™çº§ï¼‰
â”‚   â””â”€â”€ optimized_system.py   # ç³»ç»Ÿåè°ƒå™¨ï¼ˆç¼–æ’å®Œæ•´åˆ†æé“¾è·¯ï¼‰
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ api_client.py         # å¼‚æ­¥ LLM API å®¢æˆ·ç«¯ï¼ˆhttpxï¼‰
â”‚   â””â”€â”€ llm_inference.py      # LLM æ¨ç†å¼•æ“å°è£…ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
â””â”€â”€ utils/
    â”œâ”€â”€ config.py             # é…ç½®è¯»å–å·¥å…·
    â””â”€â”€ structured_logger.py  # ç»“æ„åŒ–æ—¥å¿—ï¼ˆJSON æ ¼å¼ï¼‰
```

**æ™ºèƒ½ä½“å·¥ä½œæµ**:

```
1. RouterAgent.route()       â€” åˆ†æè½½è·æ–‡æœ¬ï¼Œè®¡ç®—è·¯ç”±åˆ†æ•°ï¼Œé€‰æ‹©æœ€ä½³ä¸“å®¶
2. ExpertAgent.analyze()     â€” æ„é€  Prompt â†’ è°ƒç”¨ LLM â†’ è§£æ JSON ç»“æœ
3. MultiAgentSystem.analyze()â€” åè°ƒ 1â†’2ï¼Œèšåˆç»“æœï¼Œè®°å½•æ—¥å¿—
```

---

## æ ¸å¿ƒæŠ€æœ¯æ ˆ

### åç«¯

| æŠ€æœ¯ | ç”¨é€” | ç‰ˆæœ¬ |
|------|------|------|
| FastAPI | å¼‚æ­¥ Web æ¡†æ¶ | 0.115+ |
| Uvicorn | ASGI æœåŠ¡å™¨ | 0.32+ |
| Pydantic | æ•°æ®éªŒè¯ | 2.9+ |
| httpx | å¼‚æ­¥ HTTP å®¢æˆ·ç«¯ | 0.27+ |
| Loguru | æ—¥å¿—ç®¡ç† | 0.7+ |

### å‰ç«¯

| æŠ€æœ¯ | ç”¨é€” | ç‰ˆæœ¬ |
|------|------|------|
| Streamlit | UI æ¡†æ¶ | 1.40+ |
| Plotly | æ•°æ®å¯è§†åŒ– | 5.24+ |
| Pandas | æ•°æ®å¤„ç† | 2.2+ |

### AI

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| Qwen LLM | å¤§è¯­è¨€æ¨¡å‹ï¼Œè¿œç¨‹ API è°ƒç”¨ï¼ˆSiliconFlowï¼‰ |

---

## API è®¾è®¡

### POST /api/analyze

åˆ†æå®‰å…¨å‘Šè­¦

**è¯·æ±‚ä½“**:

```json
{
  "attack_type": "SQLæ³¨å…¥",
  "payload": "SELECT * FROM users WHERE id='1' UNION SELECT username, password FROM admin--",
  "source_ip": "192.168.1.100",
  "dest_ip": "10.0.0.5",
  "protocol": "HTTP"
}
```

**å“åº”**:

```json
{
  "success": true,
  "task_id": "uuid",
  "analysis_id": "uuid",
  "timestamp": 1739612345.678,
  "routing": {
    "selected_route": "web_attack",
    "confidence": 0.95
  },
  "expert_analysis": {
    "attack_technique": "SQLæ³¨å…¥",
    "risk_score": 8.5,
    "threat_level": "é«˜å±",
    "analysis": "è¯¦ç»†åˆ†æå†…å®¹...",
    "recommendations": ["ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢", "éƒ¨ç½²WAF"]
  },
  "performance": {
    "total_time_ms": 2341,
    "routing_time_ms": 5,
    "expert_time_ms": 2300
  }
}
```

### GET /api/history

è·å–åˆ†æå†å²

**æŸ¥è¯¢å‚æ•°**: `limit`, `offset`, `threat_level`, `attack_type`

### GET /api/stats

è·å–ç³»ç»Ÿç»Ÿè®¡

**å“åº”**:

```json
{
  "total_analyses": 156,
  "threat_level_distribution": { "é«˜å±": 45, "ä¸­å±": 78, "ä½å±": 33 },
  "attack_type_distribution": { "SQLæ³¨å…¥": 56, "XSSæ”»å‡»": 42, "å‘½ä»¤æ³¨å…¥": 28 }
}
```

### GET /api/health

å¥åº·æ£€æŸ¥ï¼Œè¿”å›æœåŠ¡çŠ¶æ€

---

## æ•°æ®æµç¨‹

### å‘Šè­¦åˆ†æå®Œæ•´é“¾è·¯

```
1. ç”¨æˆ·æäº¤å‘Šè­¦ (Streamlit å‰ç«¯)
         â†“
2. POST /api/analyze (FastAPI æ ¡éªŒè¯·æ±‚)
         â†“
3. AgentService.analyze_alert() (ä¸šåŠ¡ç¼–æ’)
         â†“
4. MultiAgentSystem.analyze() (æ™ºèƒ½ä½“åè°ƒ)
         â†“
   â”œâ”€â”€â†’ RouterAgent.route()     â†’ è®¡ç®—è·¯ç”±åˆ†æ•° â†’ é€‰æ‹©ä¸“å®¶
   â””â”€â”€â†’ ExpertAgent.analyze()   â†’ æ„é€  Prompt â†’ LLM åˆ†æ â†’ è§£æç»“æœ
         â†“
5. MemoryStorage.save_analysis() (ä¿å­˜å†å²)
         â†“
6. è¿”å› AnalysisResult â†’ å‰ç«¯å±•ç¤º
```

---

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„ä¸“å®¶æ™ºèƒ½ä½“

1. åœ¨ `src/agents/optimized_expert.py` çš„ `prompt_templates` ä¸­æ·»åŠ æ–°çš„æç¤ºè¯æ¨¡æ¿
2. åœ¨ `src/agents/optimized_system.py` çš„ `expert_types` åˆ—è¡¨ä¸­æ³¨å†Œæ–°ä¸“å®¶
3. åœ¨ `src/agents/optimized_router.py` çš„ `routing_rules` ä¸­æ·»åŠ è·¯ç”±è§„åˆ™

### æ·»åŠ æ–°çš„ API ç«¯ç‚¹

1. åœ¨ `backend/api/models/schemas.py` å®šä¹‰æ•°æ®æ¨¡å‹
2. åœ¨ `backend/api/routes/` åˆ›å»ºè·¯ç”±æ–‡ä»¶
3. åœ¨ `backend/main.py` ä¸­ `include_router` æ³¨å†Œè·¯ç”±

### æ·»åŠ æ–°çš„å‰ç«¯é¡µé¢

åœ¨ `frontend/pages/` ä¸‹åˆ›å»ºæ–°æ–‡ä»¶ï¼Œæ–‡ä»¶åæ ¼å¼: `åºå·_å›¾æ ‡_é¡µé¢å.py`

```python
import streamlit as st
from frontend.utils.api_client import APIClient

st.set_page_config(page_title="æ–°é¡µé¢", page_icon="âš™ï¸")
st.title("âš™ï¸ æ–°é¡µé¢")
api_client = APIClient("http://localhost:8000")
```

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡ (.env)

| å˜é‡å | å¿…éœ€ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|------|--------|
| `LLM_API_KEY` | âœ… | LLM API å¯†é’¥ | â€” |
| `MODEL_NAME` | âœ… | LLM æ¨¡å‹åç§° | â€” |
| `MODEL_URL` | âœ… | LLM API åŸºç¡€ URL | â€” |
| `API_HOST` | âŒ | åç«¯ç›‘å¬åœ°å€ | `0.0.0.0` |
| `API_PORT` | âŒ | åç«¯ç›‘å¬ç«¯å£ | `8000` |
| `API_RELOAD` | âŒ | çƒ­é‡è½½ï¼ˆå¼€å‘ç”¨ï¼‰ | `true` |
| `LOG_LEVEL` | âŒ | æ—¥å¿—çº§åˆ« | `INFO` |

---

## éƒ¨ç½²

### æ‰‹åŠ¨éƒ¨ç½²

```bash
# 1. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env å¡«å…¥ API å¯†é’¥

# 3. å¯åŠ¨åç«¯ï¼ˆç»ˆç«¯1ï¼‰
python start_backend.py

# 4. å¯åŠ¨å‰ç«¯ï¼ˆç»ˆç«¯2ï¼‰
python start_frontend.py
```

---

## å®‰å…¨å»ºè®®

1. **API å¯†é’¥**: ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†ï¼Œä¸è¦ç¡¬ç¼–ç æˆ–æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
2. **è¾“å…¥éªŒè¯**: Pydantic ä¸¥æ ¼éªŒè¯æ‰€æœ‰ API è¾“å…¥
3. **CORS**: ä»…å…è®¸é…ç½®çš„å‰ç«¯æºè®¿é—®
4. **ç”Ÿäº§ç¯å¢ƒ**: å»ºè®®æ·»åŠ  JWT è®¤è¯ã€HTTPSã€è¯·æ±‚é™æµ

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2026-02-15
