# 开发指南

## 系统架构概览

```
Frontend (Streamlit)  ←→  Backend (FastAPI)  ←→  Agent System (src/)
        ↓                        ↓                         ↓
    用户界面               RESTful API             多智能体分析 + LLM
                               ↓
                    MemoryStorage（内存告警历史）
                    RAGService（ChromaDB 向量库）
```

---

## 核心技术栈

### 后端

| 技术 | 用途 | 版本 |
|------|------|------|
| FastAPI | 异步 Web 框架 | 0.115+ |
| Uvicorn | ASGI 服务器 | 0.32+ |
| Pydantic | 数据验证与序列化 | 2.9+ |
| httpx | 异步 HTTP 客户端（调用远程 LLM） | 0.27+ |
| openai | OpenAI 兼容 SDK（RAG Embedding 调用） | 1.12+ |
| chromadb | 本地向量数据库（RAG 存储） | 0.5+ |
| Loguru | 日志框架 | 0.7+ |

### 前端

| 技术 | 用途 | 版本 |
|------|------|------|
| Streamlit | 多页面 Web UI 框架 | 1.40+ |
| Plotly | 交互式图表 | 5.24+ |
| Pandas | 数据表格处理 | 2.2+ |
| requests | 同步 HTTP 客户端（前端→后端） | 2.32+ |

### AI / 模型

| 技术 | 用途 |
|------|------|
| Qwen LLM（SiliconFlow API）| 多智能体告警分析 + RAG 答案生成 |
| Qwen3-Embedding-8B（SiliconFlow API）| RAG 文本向量化 |

---

## 配置说明

### 环境变量 (`.env`)

| 变量名 | 必需 | 说明 | 默认值 |
|--------|------|------|--------|
| `LLM_API_KEY` | ✅ | SiliconFlow API 密钥 | — |
| `MODEL_NAME` | ✅ | 对话 LLM 模型名称 | — |
| `MODEL_URL` | ✅ | LLM API 基础 URL | — |
| `EMBEDDING_API_KEY` | ✅ | Embedding API 密钥（可与 LLM Key 相同） | 复用 `LLM_API_KEY` |
| `EMBEDDING_MODEL` | ❌ | Embedding 模型名称 | `Qwen/Qwen3-Embedding-8B` |
| `EMBEDDING_URL` | ❌ | Embedding API 基础 URL | `https://api.siliconflow.cn/v1` |
| `API_HOST` | ❌ | 后端监听地址 | `0.0.0.0` |
| `API_PORT` | ❌ | 后端监听端口 | `8000` |
| `API_RELOAD` | ❌ | 热重载（仅开发环境） | `true` |
| `LOG_LEVEL` | ❌ | 日志级别 | `INFO` |

---

## 数据流程

### 多智能体告警分析链路

```
1. 用户在 Streamlit 填写告警信息 → 点击「开始分析」
2. POST /api/analyze（FastAPI 校验请求体）
3. AgentService.analyze_alert()（业务编排）
4. MultiAgentSystem.analyze()（智能体协调器）
   ├─ RouterAgent.route()       → 关键词 + 正则评分，选择最佳专家
   └─ ExpertAgent.analyze()     → 领域 Prompt → Qwen LLM → JSON 解析
5. MemoryStorage.save_analysis()（保存内存历史）
6. 返回 AnalysisResult → 前端展示
```

### RAG 文档入库链路

```
1. 用户粘贴文本 / 上传文件 → 点击「入库」
2. POST /api/rag/upload
3. RAGService.add_documents()
   ├─ 文本分块（500字/块，50字重叠）
   ├─ SiliconFlow Qwen3-Embedding-8B → 向量化
   └─ ChromaDB 持久化存储（余弦相似度索引）
```

### RAG 问答链路

```
1. 用户输入问题 → 点击「提问」
2. POST /api/rag/query
3. RAGService.query_and_generate()
   ├─ 问题向量化（Qwen3-Embedding-8B）
   ├─ ChromaDB 余弦相似度检索（top-k 文档块）
   ├─ 拼接 Context + 构建 Prompt
   └─ Qwen LLM 生成答案
4. 返回：答案 + 参考文档片段（含来源和相似度分数）
```

---

## API 设计

### POST /api/analyze — 告警分析

**请求体**：

```json
{
  "attack_type": "SQL注入",
  "payload": "SELECT * FROM users WHERE id='1' UNION SELECT username, password FROM admin--",
  "source_ip": "192.168.1.100",
  "dest_ip": "10.0.0.5"
}
```

**响应**：

```json
{
  "task_id": "uuid",
  "routing": {
    "selected_route": "web_attack",
    "confidence": 0.95
  },
  "expert_analysis": {
    "attack_technique": "SQL注入 - UNION SELECT攻击",
    "risk_score": 8.5,
    "threat_level": "高危",
    "analysis": "...",
    "recommendations": ["使用参数化查询", "部署WAF"]
  },
  "performance": {
    "total_time_ms": 2341,
    "routing_time_ms": 5,
    "expert_time_ms": 2336
  }
}
```

### POST /api/rag/upload — 文档入库

```json
{ "texts": ["文档内容..."], "source_name": "网络安全手册" }
```

### POST /api/rag/query — 知识库问答

```json
{ "question": "什么是 SQL 注入？", "top_k": 3 }
```

**响应**：

```json
{
  "answer": "SQL 注入是...",
  "sources": [
    { "text": "原文片段...", "source": "网络安全手册", "score": 0.923 }
  ],
  "has_context": true
}
```

---

## 扩展开发指南

### 添加新的专家智能体

1. 在 `src/agents/optimized_expert.py` 的 `prompt_templates` 字典中添加新专家的提示词模板
2. 在 `src/agents/optimized_system.py` 的 `expert_types` 列表中注册新专家类型
3. 在 `src/agents/optimized_router.py` 的 `routing_rules` 中添加对应的路由关键词和正则规则

### 添加新的 API 端点

1. 在 `backend/api/models/schemas.py` 定义新的 Pydantic 请求/响应模型
2. 在 `backend/api/routes/` 下创建新路由文件（或在已有文件中添加路由）
3. 在 `backend/main.py` 使用 `app.include_router()` 注册路由

### 添加新的前端页面

在 `frontend/pages/` 下创建新文件，命名格式为 `序号_图标_页面名.py`，Streamlit 会自动将其注册到左侧导航栏。

```python
import streamlit as st
from frontend.utils.api_client import APIClient

st.set_page_config(page_title="新页面", page_icon="⚙️")
st.title("⚙️ 新功能页面")
api_client = APIClient("http://localhost:8000")
```

---

## 安全建议

1. **API 密钥**：存储在 `.env` 文件中，已加入 `.gitignore`，不要硬编码或提交
2. **输入验证**：所有 API 输入通过 Pydantic 严格验证
3. **CORS 隔离**：后端仅允许来自 Streamlit 前端的跨域请求
4. **告警历史**：存储在内存中（`MemoryStorage`），服务重启后清空
5. **RAG 向量库**：数据存储在 `chroma_db/` 目录（通过 Docker volume 持久化）

---

**文档版本**: 2.0.0 | **更新**: 2026-02-25
