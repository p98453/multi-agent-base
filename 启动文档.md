# Docker 部署启动文档

## 容器内架构

```
┌─────────────────────────────────────────────┐
│           Docker Container                  │
│                                             │
│  supervisord                                │
│    ├── FastAPI Backend    :8000             │
│    └── Streamlit Frontend :8501             │
│                                             │
│  Volume: ./logs      → /app/logs           │
│  Volume: ./chroma_db → /app/chroma_db      │
└──────┬──────────────────┬───────────────────┘
       │                  │
   端口 8000          端口 8501
   (后端 API)         (前端界面)
```

## 前提条件

- 已安装 [Docker](https://docs.docker.com/get-docker/) 和 [Docker Compose](https://docs.docker.com/compose/install/)
- 已配置 `.env` 文件（包含 API 密钥，见下方说明）

## 1. 配置环境变量

编辑根目录的 `.env` 文件，填入必需字段：

```env
# ===== LLM 对话模型（必填）=====
LLM_API_KEY=your_siliconflow_api_key
MODEL_NAME=Qwen/Qwen2.5-7B-Instruct
MODEL_URL=https://api.siliconflow.cn/v1

# ===== Embedding 模型（RAG 功能必填）=====
EMBEDDING_API_KEY=your_siliconflow_api_key
EMBEDDING_MODEL=Qwen/Qwen3-Embedding-8B
EMBEDDING_URL=https://api.siliconflow.cn/v1
```

> `EMBEDDING_API_KEY` 与 `LLM_API_KEY` 可使用同一个 SiliconFlow API Key。

## 2. 构建并启动容器

```bash
docker-compose up -d --build
```

> 首次构建时需下载基础镜像及安装依赖，约需数分钟。

## 3. 访问服务

| 服务 | 地址 |
|------|------|
| 前端界面 | http://localhost:8501 |
| 后端 API 文档（Swagger） | http://localhost:8000/docs |
| 健康检查 | http://localhost:8000/api/health |

## 常用运维命令

```bash
# 查看容器状态
docker-compose ps

# 实时查看日志（所有进程）
docker-compose logs -f

# 仅查看后端日志
docker-compose exec multi-agent cat /app/logs/backend.log

# 仅查看前端日志
docker-compose exec multi-agent cat /app/logs/frontend.log

# 重启服务（不重建镜像）
docker-compose restart

# 停止并移除容器
docker-compose down

# 代码更新后重新构建并启动
docker-compose up -d --build
```

## 数据持久化说明

| 路径（宿主机） | 容器内路径 | 内容 |
|----------------|------------|------|
| `./logs/` | `/app/logs/` | 后端、前端、supervisord 日志 |
| `./chroma_db/` | `/app/chroma_db/` | RAG 向量库（重启不丢失） |

> **日志文件说明**：
> - `backend.log` / `backend_error.log` — FastAPI 后端运行日志
> - `frontend.log` / `frontend_error.log` — Streamlit 前端运行日志
> - `supervisord.log` — 进程管理器日志

## Docker 相关文件说明

| 文件 | 说明 |
|------|------|
| `Dockerfile` | 镜像构建配置，基于 `python:3.11-slim`，使用 supervisord 管理进程 |
| `supervisord.conf` | 配置后端（`start_backend.py`）和前端（`streamlit run`）同时启动 |
| `docker-compose.yml` | 端口映射（8000/8501）、`.env` 注入、日志和向量库 volume 挂载 |
| `.dockerignore` | 排除 `__pycache__`、`.git`、`.env`、`chroma_db/` 等，减小构建上下文 |

## 常见问题排查

| 现象 | 排查方式 |
|------|---------|
| 容器启动后前端无法访问 | `docker-compose ps` 确认容器状态为 `Up`，检查 8501 端口是否被占用 |
| API 返回 500 错误 | 检查 `.env` 中的 `LLM_API_KEY` 是否填写正确，查看 `backend_error.log` |
| RAG 入库失败 | 检查 `EMBEDDING_API_KEY` 和 `EMBEDDING_MODEL` 配置，查看 `backend.log` |
| 前端显示"后端服务未连接" | 确认后端已成功启动，`/api/health` 返回 200 |
| 端口被占用 | 修改 `docker-compose.yml` 中端口映射，如 `"9000:8000"` |
