# Docker 部署启动文档

## 项目架构

```
┌─────────────────────────────────────────┐
│           Docker Container              │
│                                         │
│  supervisord                            │
│    ├── FastAPI Backend   :8000          │
│    └── Streamlit Frontend :8501         │
│              │                          │
│              └── localhost:8000 ──► API  │
└──────┬──────────────┬───────────────────┘
       │              │
   端口 8000       端口 8501
       │              │
    API 文档       前端界面
```

## 前提条件

- 已安装 [Docker](https://docs.docker.com/get-docker/) 和 [Docker Compose](https://docs.docker.com/compose/install/)
- 已配置 `.env` 文件（包含 LLM API Key）

## 快速启动

### 1. 配置环境变量

```bash
# 复制模板并填入 API Key
cp .env.example .env
```

编辑 `.env`，填入以下必需字段：

```env
LLM_API_KEY=your_api_key_here
MODEL_NAME=Qwen/Qwen3-30B-A3B-Thinking-2507
MODEL_URL=https://api.siliconflow.cn/v1
```

### 2. 构建并启动容器

```bash
docker-compose up -d --build
```

### 3. 访问服务

| 服务 | 地址 |
|------|------|
| 前端界面 | http://localhost:8501 |
| 后端 API 文档 (Swagger) | http://localhost:8000/docs |
| 健康检查 | http://localhost:8000/api/health |

## 常用命令

```bash
# 查看容器状态
docker-compose ps

# 查看实时日志
docker-compose logs -f

# 仅查看后端日志
docker-compose exec multi-agent cat /app/logs/backend.log

# 仅查看前端日志
docker-compose exec multi-agent cat /app/logs/frontend.log

# 重启服务
docker-compose restart

# 停止并移除容器
docker-compose down

# 重新构建（代码更新后）
docker-compose up -d --build
```

## 文件说明

| 文件 | 说明 |
|------|------|
| `Dockerfile` | 镜像构建配置，基于 `python:3.11-slim` + supervisord |
| `supervisord.conf` | 进程管理，同时运行后端和前端 |
| `docker-compose.yml` | 编排配置：端口映射、环境变量注入、日志持久化 |
| `.dockerignore` | 排除不必要文件，减小镜像体积 |

## 日志与排错

- 容器日志持久化到宿主机 `./logs/` 目录
- 后端日志：`./logs/backend.log` / `./logs/backend_error.log`
- 前端日志：`./logs/frontend.log` / `./logs/frontend_error.log`
- supervisord 日志：`./logs/supervisord.log`

**常见问题：**

| 问题 | 解决方案 |
|------|----------|
| 容器启动后无法访问 | 检查 `docker-compose ps` 确认容器状态为 `Up` |
| API 返回 500 错误 | 检查 `.env` 中的 `LLM_API_KEY` 是否正确 |
| 前端显示连接失败 | 确认后端已启动，查看 `backend_error.log` |
| 端口被占用 | 修改 `docker-compose.yml` 中的端口映射，如 `"9000:8000"` |
