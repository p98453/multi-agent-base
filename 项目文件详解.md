# 多智能体安全分析系统 - 项目文件详解

> 本文档详细解释了项目中每个文件的作用、核心逻辑和彼此间的关系。

---

## 目录

- [一、项目总体架构](#一项目总体架构)
- [二、根目录文件](#二根目录文件)
- [三、核心引擎层 (`src/`)](#三核心引擎层-src)
- [四、后端服务层 (`backend/`)](#四后端服务层-backend)
- [五、前端展示层 (`frontend/`)](#五前端展示层-frontend)
- [六、数据流完整链路](#六数据流完整链路)

---

## 一、项目总体架构

本项目是一个 **多智能体网络安全威胁智能分析系统**，采用前后端分离的三层架构：

```
┌──────────────────────────────────────────────────────────────┐
│  前端 (Streamlit)            端口: 8501                      │
│  ├─ 告警分析页面                                              │
│  ├─ 分析历史页面                                              │
│  └─ 系统仪表板页面                                            │
├──────────────────────────────────────────────────────────────┤
│  后端 API (FastAPI)          端口: 8000                      │
│  ├─ /api/analyze    → 告警分析                                │
│  ├─ /api/history    → 历史查询                                │
│  ├─ /api/stats      → 统计数据                                │
│  └─ /api/health     → 健康检查                                │
├──────────────────────────────────────────────────────────────┤
│  核心引擎 (多智能体系统)                                       │
│  ├─ 路由智能体 (Router)      → 基于关键词+正则的告警分类         │
│  ├─ 专家智能体 (Expert ×3)   → 调用远程LLM进行深度分析           │
│  └─ 系统协调器 (System)      → 编排路由→专家的完整处理链路        │
└──────────────────────────────────────────────────────────────┘
```

**技术栈：** Python · FastAPI · Streamlit · Qwen LLM (SiliconFlow远程API) · Pydantic · Plotly

---

## 二、根目录文件

### `start_backend.py` — 后端启动脚本

**作用：** 一键启动 FastAPI 后端服务的入口脚本。

**核心逻辑：**

1. 将项目根目录加入 `sys.path`，解决模块导入问题
2. 读取 `BackendConfig` 中的主机/端口配置
3. 调用 `uvicorn.run()` 启动 ASGI 服务器，加载 `backend.main:app`

**启动命令：** `python start_backend.py`

---

### `start_frontend.py` — 前端启动脚本

**作用：** 一键启动 Streamlit 前端界面的入口脚本。

**核心逻辑：**

1. 定位 `frontend/app.py` 的绝对路径
2. 通过 `subprocess.run()` 调用 `streamlit run`，指定端口 8501

**启动命令：** `python start_frontend.py`

---

### `requirements.txt` — Python 依赖清单

**作用：** 声明项目所有第三方依赖库及其版本。

| 分类 | 依赖                | 用途                            |
| ---- | ------------------- | ------------------------------- |
| 核心 | `python-dotenv`     | 加载 `.env` 环境变量            |
| 核心 | `openai`            | OpenAI 兼容 API 客户端（备用）  |
| 核心 | `loguru`            | 高级日志框架                    |
| 后端 | `fastapi`           | Web API 框架                    |
| 后端 | `uvicorn[standard]` | ASGI 服务器                     |
| 后端 | `pydantic`          | 数据校验与序列化                |
| 后端 | `httpx`             | 异步 HTTP 客户端（调用远程LLM） |
| 前端 | `streamlit`         | 交互式 Web 界面                 |
| 前端 | `plotly`            | 交互式图表                      |
| 前端 | `pandas`            | 数据表格处理                    |
| 前端 | `requests`          | HTTP 客户端（前端→后端通信）    |
| 异步 | `aiohttp`           | 异步 HTTP 支持                  |

---

### `.env.example` — 环境变量模板

**作用：** 提供 `.env` 文件的配置模板，包含所有可配置项及默认值。

**关键配置项：**

- `LLM_API_KEY` — **必填**，远程 LLM 服务的 API 密钥
- `MODEL_NAME` — LLM 模型名称（默认 `Qwen/Qwen3-30B-A3B-Thinking-2507`）
- `MODEL_URL` — LLM API 地址（默认 SiliconFlow）
- `API_HOST` / `API_PORT` — 后端服务监听地址
- `API_RELOAD` — 是否开启热重载

---

### `.gitignore` — Git 忽略规则

**作用：** 配置 Git 版本控制需要忽略的文件和目录，包括：

- Python 缓存文件（`__pycache__/`、`.pyc`）
- 虚拟环境（`venv/`）
- 环境变量文件（`.env`）
- 日志目录（`logs/`）
- 数据库文件（`chroma_db/`）
- IDE 配置（`.vscode/`、`.idea/`）

---

### `README.md` / `DEVELOPMENT.md` / `PROJECT_STRUCTURE.md` / `REFACTORING_TUTORIAL.md`

| 文件                      | 作用                                |
| ------------------------- | ----------------------------------- |
| `README.md`               | 项目主说明文档                      |
| `DEVELOPMENT.md`          | 开发指南                            |
| `PROJECT_STRUCTURE.md`    | 项目结构说明                        |
| `REFACTORING_TUTORIAL.md` | 重构教程（从本地模型迁移到远程API） |

---

## 三、核心引擎层 (`src/`)

### `src/__init__.py` — 包初始化

**作用：** 标记 `src` 为 Python 包，定义版本号 `1.0.0`。

---

### `src/agents/` — 智能体模块（核心业务逻辑）

#### `src/agents/__init__.py` — 智能体包导出

**作用：** 统一导出三个核心类：

- `OptimizedRouterAgent` — 路由智能体
- `OptimizedExpertAgent` — 专家智能体
- `MultiAgentSystem` — 多智能体协调系统

---

#### `src/agents/optimized_router.py` — 路由智能体 ⭐

**作用：** 分析输入的安全告警，判断其属于哪种攻击类型，并路由到对应的专家智能体。

**类：** `OptimizedRouterAgent`

**核心逻辑：**

1. **分类规则定义** — 维护三大攻击类别的匹配规则：
   - `web_attack`：关键词（sql、xss、inject…）+ 正则（UNION SELECT、`<script>`…）
   - `vulnerability_attack`：关键词（cve、exploit…）+ 正则（CVE编号…）
   - `illegal_connection`：关键词（c2、botnet、ddos…）+ 正则
2. **评分机制** — `_calculate_scores()` 方法：
   - 关键词命中 × 0.6 权重
   - 正则命中 × 0.4 权重
   - 取最高分类别作为路由目标
3. **置信度计算** — 分数 < 0.5 时置信度降为 0.3，否则按比例映射到 [0, 1]
4. **异步接口** — `route()` 为 `async` 方法，与 FastAPI 异步生态兼容

**设计亮点：** 正则表达式在初始化时预编译（`re.compile`），避免重复编译开销。

---

#### `src/agents/optimized_expert.py` — 专家智能体 ⭐

**作用：** 针对特定攻击类型，调用远程 LLM 进行深度威胁分析。

**类：** `OptimizedExpertAgent`

**三种专家类型：**
| 类型 | 专家角色 | 分析内容 |
|------|---------|---------|
| `web_attack` | Web安全专家 | SQL注入、XSS、命令注入等 |
| `vulnerability_attack` | 漏洞利用专家 | CVE漏洞、Shellcode、溢出攻击等 |
| `illegal_connection` | 网络连接专家 | C2通信、僵尸网络、DDoS等 |

**核心逻辑：**

1. **Prompt 工程** — 每种专家类型有专属的提示词模板，引导 LLM 输出结构化 JSON
2. **LLM 调用** — 通过 `get_llm_inference()` 获取全局 LLM 实例，异步调用 `generate_response()`
3. **JSON 解析** — `_parse_response()` 从 LLM 响应中提取 JSON 块
4. **降级机制** — LLM 调用失败时，自动降级到 `_rule_based_analysis()` 基于规则的分析：
   - 关键词匹配识别 SQL注入、XSS、命令注入、C2通信
   - 给出预设的风险评分和防御建议

---

#### `src/agents/optimized_system.py` — 多智能体协调系统 ⭐

**作用：** 编排路由智能体和专家智能体，实现完整的告警分析流水线。

**类：** `MultiAgentSystem`

**核心逻辑：**

1. **初始化** — `initialize()` 方法依次创建：
   - 1 个路由智能体（`OptimizedRouterAgent`）
   - 3 个专家智能体（分别对应三种攻击类型）
   - 1 个结构化日志记录器
2. **分析链路** — `analyze()` 方法的三阶段流程：
   - **阶段1：路由决策** → 调用 `router.route()` 确定攻击类别
   - **阶段2：专家分析** → 根据路由结果选择对应专家，调用 `expert.analyze()`
   - **阶段3：结果综合** → 汇总路由信息、专家分析、性能指标
3. **结果格式** — 返回包含 `task_id`、`routing`、`expert_analysis`、`performance` 的完整字典

---

### `src/models/` — 模型推理模块

#### `src/models/__init__.py` — 模型包导出

**作用：** 导出 `APIClient`、`LLMInference`、`get_llm_inference`。

---

#### `src/models/api_client.py` — 远程 API 客户端

**作用：** 封装与 SiliconFlow/Qwen 远程 LLM API 的 HTTP 通信。

**类：** `APIClient`

**核心方法：**
| 方法 | 用途 | API 端点 |
|------|------|---------|
| `generate()` | 文本生成（Chat Completions） | `/chat/completions` |
| `get_embedding()` | 获取文本向量嵌入 | `/embeddings` |

**关键细节：**

- 使用 `httpx.AsyncClient` 进行异步 HTTP 请求
- 从 `.env` 读取 API Key、模型名称、API URL
- 文本生成超时 60s，嵌入获取超时 30s

---

#### `src/models/llm_inference.py` — LLM 推理封装

**作用：** 对 `APIClient` 的高层封装，提供全局单例模式的 LLM 推理接口。

**类：** `LLMInference`

**设计模式：**

- **全局单例** — 通过 `_GLOBAL_CLIENT` 和 `get_llm_inference()` 确保整个应用共享一个 API 客户端实例
- **惰性初始化** — 首次调用时才创建客户端

**核心方法：**

- `generate_response()` — 异步生成 LLM 文本响应
- `get_embedding()` — 异步获取文本向量

---

### `src/utils/` — 工具模块

#### `src/utils/config.py` — 全局配置

**作用：** 从 `.env` 文件加载并集中管理 LLM 相关配置。

**类：** `Config`

**配置项：** `LLM_API_KEY`、`MODEL_NAME`、`MODEL_URL`、`EMBEDDING_MODEL_NAME`

---

#### `src/utils/structured_logger.py` — 结构化日志记录器

**作用：** 提供 JSON 格式的结构化日志，实时追踪多智能体系统的完整处理链路。

**类：** `StructuredLogger`

**核心功能：**

1. **实时写入** — 每条日志以 JSONL 格式实时追加到文件（`logs/analysis_YYYYMMDD_HHMMSS.jsonl`）
2. **统计跟踪** — 自动统计 token 消耗、处理时间、各阶段调用次数
3. **会话摘要** — `save()` 方法生成 `.summary.json` 汇总文件
4. **控制台输出** — 同时在控制台打印日志

**全局实例管理：**

- `get_logger()` — 获取全局 logger 单例
- `reset_logger()` — 重置 logger（用于新分析会话）

---

## 四、后端服务层 (`backend/`)

### `backend/__init__.py` — 包初始化

**作用：** 标记 `backend` 为 Python 包。

---

### `backend/config.py` — 后端配置管理

**作用：** 集中管理 FastAPI 服务的所有配置。

**类：** `BackendConfig`

**关键配置项：**
| 配置 | 默认值 | 说明 |
|------|-------|------|
| `API_HOST` | `0.0.0.0` | 服务监听地址 |
| `API_PORT` | `8000` | 服务端口 |
| `API_RELOAD` | `True` | 热重载（开发模式） |
| `CORS_ORIGINS` | localhost:8501 等 | 允许的跨域来源 |
| `LOG_LEVEL` | `INFO` | 日志级别 |

**验证机制：** `validate()` 方法检查 `LLM_API_KEY`、`MODEL_NAME`、`MODEL_URL` 是否已设置。

---

### `backend/main.py` — FastAPI 主应用 ⭐

**作用：** FastAPI 应用的入口，负责应用创建、中间件配置、路由注册和生命周期管理。

**核心逻辑：**

1. **生命周期管理** — `lifespan()` 上下文管理器：
   - 启动时：验证配置 → 初始化智能体服务
   - 关闭时：清理资源
2. **CORS 中间件** — 允许 Streamlit 前端跨域访问
3. **路由注册** — 挂载 `analysis` 和 `stats` 路由模块
4. **根端点** — `GET /` 返回服务信息和文档链接

---

### `backend/api/` — API 接口层

#### `backend/api/__init__.py` — API 包初始化

#### `backend/api/models/__init__.py` — 数据模型导出

**作用：** 导出 `AlertData`、`AnalysisResult`、`AnalysisHistory`、`SystemStats` 四个 Pydantic 模型。

---

#### `backend/api/models/schemas.py` — API 数据模型定义 ⭐

**作用：** 使用 Pydantic 定义所有 API 请求/响应的数据结构，自动进行数据校验。

| 模型                 | 用途         | 关键字段                                                                  |
| -------------------- | ------------ | ------------------------------------------------------------------------- |
| `AlertData`          | 告警输入     | `attack_type`、`payload`、`source_ip`、`dest_ip`                          |
| `RoutingInfo`        | 路由信息     | `selected_route`、`confidence`                                            |
| `ExpertAnalysis`     | 专家分析结果 | `attack_technique`、`risk_score`、`threat_level`、`recommendations`       |
| `PerformanceMetrics` | 性能指标     | `total_time_ms`、`routing_time_ms`、`expert_time_ms`                      |
| `AnalysisResult`     | 完整分析结果 | 组合以上三个子模型 + `task_id`、`timestamp`                               |
| `AnalysisHistory`    | 历史记录条目 | `analysis_id`、`attack_type`、`threat_level`、`risk_score`                |
| `SystemStats`        | 系统统计     | `total_analyses`、`threat_level_distribution`、`attack_type_distribution` |

---

#### `backend/api/routes/__init__.py` — 路由模块导出

**作用：** 导出 `analysis_router` 和 `stats_router`。

---

#### `backend/api/routes/analysis.py` — 分析路由

**作用：** 定义告警分析和历史查询的 API 端点。

| 端点           | 方法 | 功能                                                   |
| -------------- | ---- | ------------------------------------------------------ |
| `/api/analyze` | POST | 接收告警数据 → 调用智能体服务分析 → 返回分析结果       |
| `/api/history` | GET  | 查询分析历史（支持分页、按威胁等级/攻击类型/时间过滤） |

---

#### `backend/api/routes/stats.py` — 统计路由

**作用：** 定义系统统计和健康检查端点。

| 端点          | 方法 | 功能                                                   |
| ------------- | ---- | ------------------------------------------------------ |
| `/api/stats`  | GET  | 返回系统统计（总分析次数、威胁等级分布、攻击类型分布） |
| `/api/health` | GET  | 健康检查（返回服务状态和版本）                         |

---

### `backend/services/` — 服务层

#### `backend/services/__init__.py` — 服务包初始化

---

#### `backend/services/agent_service.py` — 智能体服务 ⭐

**作用：** 连接 API 层和核心引擎层的桥梁，封装异步分析逻辑。

**类：** `AgentService`（全局单例，通过 `get_agent_service()` 获取）

**核心方法：**
| 方法 | 功能 |
|------|------|
| `initialize()` | 创建并初始化 `MultiAgentSystem` |
| `analyze_alert()` | 将 Pydantic `AlertData` 转为字典 → 调用多智能体系统分析 → 保存到内存存储 → 返回 `AnalysisResult` |
| `get_analysis_history()` | 委托给 `MemoryStorage` 查询历史 |
| `get_stats()` | 委托给 `MemoryStorage` 获取统计 |

---

#### `backend/services/memory_storage.py` — 内存存储服务

**作用：** 替代 ChromaDB，在内存中存储分析历史记录（轻量级方案）。

**类：** `MemoryStorage`（全局单例，通过 `get_memory_storage()` 获取）

**核心功能：**

- **保存分析** — 将结果插入到列表头部，最大保留 100 条
- **查询历史** — 支持按威胁等级、攻击类型、时间范围过滤 + 分页
- **统计信息** — 计算威胁等级分布和攻击类型分布

**注意：** 数据仅保存在内存中，服务重启后丢失。

---

## 五、前端展示层 (`frontend/`)

### `frontend/__init__.py` — 包初始化

**作用：** 标记 `frontend` 为 Python 包。

---

### `frontend/app.py` — Streamlit 主页面 ⭐

**作用：** 前端应用的入口页面，展示系统介绍和导航入口。

**核心功能：**

1. **页面配置** — 设置标题、图标、宽屏布局
2. **功能介绍** — 展示三大核心功能（告警分析、分析历史、系统仪表板）
3. **侧边栏** — 显示后端连接状态（调用 `health_check()`）、技术栈信息

---

### `frontend/pages/` — Streamlit 多页面

#### `frontend/pages/1_🔍_Alert_Analysis.py` — 告警分析页面 ⭐

**作用：** 用户提交安全告警并查看分析结果的主要交互界面。

**核心功能：**

1. **预设示例** — 内置 7 种攻击类型示例（SQL注入、XSS、命令注入、目录遍历、C2通信、Webshell、其他），可一键加载到表单
2. **输入表单** — 攻击类型选择、载荷输入、源/目标 IP 输入
3. **结果展示** — 分析完成后展示：
   - 关键指标（任务ID、威胁等级、风险评分、处理耗时）
   - 三个 Tab：专家分析 / 路由决策 / 性能指标
   - 完整 JSON 结果展开区

---

#### `frontend/pages/2_📊_Analysis_History.py` — 分析历史页面

**作用：** 展示和查询所有历史分析记录。

**核心功能：**

1. **过滤器** — 支持按威胁等级、攻击类型筛选，可调整显示条数
2. **统计概览** — 总记录数、高危告警数、平均风险分
3. **数据表格** — 使用 Pandas DataFrame 展示历史记录，支持排序

---

#### `frontend/pages/4_📈_System_Dashboard.py` — 系统仪表板页面

**作用：** 可视化展示系统统计数据。

**核心功能：**

1. **关键指标** — 总分析次数、高危告警占比、攻击类型数
2. **图表展示**：
   - **威胁等级分布** — Plotly 环形饼图（颜色编码：严重-红、高危-橙、中危-黄、低危-绿）
   - **攻击类型分布** — Plotly 柱状图（热力色阶）
3. **原始数据** — 可展开查看 JSON 格式的统计原始数据

---

### `frontend/utils/` — 前端工具模块

#### `frontend/utils/__init__.py` — 工具包初始化

---

#### `frontend/utils/api_client.py` — 前端 API 客户端

**作用：** 封装前端与 FastAPI 后端的所有 HTTP 通信。

**类：** `APIClient`

| 方法                     | HTTP 方法 | 后端端点       | 功能             |
| ------------------------ | --------- | -------------- | ---------------- |
| `health_check()`         | GET       | `/api/health`  | 检查后端是否在线 |
| `analyze_alert()`        | POST      | `/api/analyze` | 提交告警分析请求 |
| `get_analysis_history()` | GET       | `/api/history` | 获取分析历史     |
| `get_stats()`            | GET       | `/api/stats`   | 获取系统统计     |

**注意：** 使用同步的 `requests` 库（而非异步 `httpx`），因为 Streamlit 本身是同步框架。

---

### `frontend/pages/__init__.py` — 页面包初始化

**作用：** 标记 `pages` 为 Python 包。

---

## 六、数据流完整链路

以用户提交一条 SQL 注入告警为例，数据的完整流转路径：

```
用户在 Streamlit 页面填写告警 → 点击"开始分析"
  │
  ▼
前端 APIClient.analyze_alert()
  │  POST /api/analyze  (JSON请求体)
  ▼
FastAPI 路由 analysis.py → analyze_alert()
  │
  ▼
AgentService.analyze_alert()
  │  AlertData → dict 转换
  ▼
MultiAgentSystem.analyze()
  │
  ├─ 阶段1: OptimizedRouterAgent.route()
  │    ├─ 关键词匹配: "sql" → web_attack +0.6
  │    ├─ 正则匹配: "UNION SELECT" → web_attack +0.4
  │    └─ 返回: {selected_route: "web_attack", confidence: 0.33}
  │
  ├─ 阶段2: OptimizedExpertAgent("web_attack").analyze()
  │    ├─ 生成 prompt → 调用远程 Qwen API
  │    ├─ 解析 JSON 响应 → 攻击技术、风险评分、建议
  │    └─ (失败时降级到规则分析)
  │
  └─ 阶段3: 汇总结果
       └─ 返回 {success, task_id, routing, expert_analysis, performance}
  │
  ▼
MemoryStorage.save_analysis()  → 保存到内存历史列表
  │
  ▼
转换为 AnalysisResult (Pydantic) → JSON 响应
  │
  ▼
前端接收 → 展示关键指标、专家分析、路由决策、性能指标
```

---

> 📝 **生成时间：** 2026-02-15  
> 📁 **项目版本：** v1.0.0
